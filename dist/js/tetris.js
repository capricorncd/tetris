var CAPR={q:function(t){return document.querySelector?document.querySelector(t):window.$?window.$(t)[0]:null},extend:function(t,e){var i={};for(var r in e)t[r]&&typeof t[r]==typeof e[r]?i[r]=t[r]:i[r]=e[r];return i},eventListener:function(t,e,i){t?t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i:console.error("The CAPR.eventListener() DOM node is undefined")},isIEBrower:"Microsoft Internet Explorer"===navigator.appName,ieBrowerVersion:function(){return/MSIE (\d+)/gi.test(navigator.userAgent)?RegExp.$1:0},isAndroid:!!navigator.userAgent.match(/android/gi),isIos:!!navigator.userAgent.match(/(iphone|ipod|ios|ipad)/gi),isMobile:!!navigator.userAgent.match(/(android|iphone|ipod|ios|ipad)/gi),isWin:"Win32"==navigator.platform||"Windows"==navigator.platform,isMac:"Mac68K"==navigator.platform||"MacPPC"==navigator.platform||"Macintosh"==navigator.platform||"MacIntel"==navigator.platform,rand:function(t){return void 0===t&&(t=1),Math.ceil(Math.random()*t)},ft:function(t){var e=CAPR.fd(Math.floor(t/60))+":"+CAPR.fd(t%60);return t>3600?CAPR.fd(Math.floor(t/3600))+":"+e:e},fd:function(t){return t<10?"0"+t:t},checkPoint:function(t,e,i,r){return!(t.x+e<0)&&(!(t.x+e>=r.length)&&(!(t.y+i<0)&&(!(t.y+i>=r[0].length)&&1!==r[t.x+e][t.y+i])))}},Square=function(){function t(t){void 0===t&&(t=1),this.data=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.SQUARES={1:[[[0,2,0,0],[0,2,0,0],[0,2,0,0],[0,2,0,0]],[[0,0,0,0],[2,2,2,2],[0,0,0,0],[0,0,0,0]]],2:[[[2,0,0,0],[2,2,0,0],[0,2,0,0],[0,0,0,0]],[[0,2,2,0],[2,2,0,0],[0,0,0,0],[0,0,0,0]]],3:[[[2,0,0,0],[2,0,0,0],[2,2,0,0],[0,0,0,0]],[[2,2,2,0],[2,0,0,0],[0,0,0,0],[0,0,0,0]],[[2,2,0,0],[0,2,0,0],[0,2,0,0],[0,0,0,0]],[[0,0,2,0],[2,2,2,0],[0,0,0,0],[0,0,0,0]]],4:[[[0,2,0,0],[0,2,0,0],[2,2,0,0],[0,0,0,0]],[[2,0,0,0],[2,2,2,0],[0,0,0,0],[0,0,0,0]],[[2,2,0,0],[2,0,0,0],[2,0,0,0],[0,0,0,0]],[[2,2,2,0],[0,0,2,0],[0,0,0,0],[0,0,0,0]]],5:[[[2,0,0,0],[2,2,0,0],[2,0,0,0],[0,0,0,0]],[[2,2,2,0],[0,2,0,0],[0,0,0,0],[0,0,0,0]],[[0,2,0,0],[2,2,0,0],[0,2,0,0],[0,0,0,0]],[[0,2,0,0],[2,2,2,0],[0,0,0,0],[0,0,0,0]]],6:[[[2,2,0,0],[2,2,0,0],[0,0,0,0],[0,0,0,0]],[[2,2,0,0],[2,2,0,0],[0,0,0,0],[0,0,0,0]]],7:[[[0,2,0,0],[2,2,0,0],[2,0,0,0],[0,0,0,0]],[[2,2,0,0],[0,2,2,0],[0,0,0,0],[0,0,0,0]]]},this.origin={x:0,y:0},this.dir=0,this.rotates=this.SQUARES[t]}return t.prototype.isValid=function(t,e,i){for(var r=0;r<e.length;r++)for(var s=0;s<e[0].length;s++)if(0!=e[r][s]&&!CAPR.checkPoint(t,r,s,i))return!1;return!0},t.prototype.canRotate=function(t){for(var e=this.rotates.length,i=(this.dir+1)%e,r=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],s=0;s<this.data.length;s++)for(var n=0;n<this.data[0].length;n++)r[s][n]=this.rotates[i][s][n];return this.isValid(this.origin,r,t)},t.prototype.rotate=function(t){void 0===t&&(t=1);var e,i;for(this.dir=(this.dir+t)%this.rotates.length,e=0;e<this.data.length;e++)for(i=0;i<this.data[0].length;i++)this.data[e][i]=this.rotates[this.dir][e][i]},t.prototype.canDown=function(t){var e={};return e.x=this.origin.x+1,e.y=this.origin.y,this.isValid(e,this.data,t)},t.prototype.down=function(){this.origin.x+=1},t.prototype.canLeft=function(t){var e={};return e.x=this.origin.x,e.y=this.origin.y-1,this.isValid(e,this.data,t)},t.prototype.left=function(){this.origin.y-=1},t.prototype.canRight=function(t){var e={};return e.x=this.origin.x,e.y=this.origin.y+1,this.isValid(e,this.data,t)},t.prototype.right=function(){this.origin.y+=1},t.prototype.canUp=function(t){var e={};return e.x=this.origin.x-1,e.y=this.origin.y,this.isValid(e,this.data,t)},t.prototype.up=function(){this.origin.x-=1},t}(),CODES={0:"Tetris readied",1:"浏览器版本过低，请升级浏览器",2:"创建Tetris DOM失败，请升级浏览器或引入jQuery/Zepte库"},Tetris=function(){function t(t){this.INTERVAL=500,this.gameTimes=0,this.isGameOver=!1,this.isPause=!1,this.gameScores=0,this.stageArray=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.stageDivs=[],this.nextDivs=[],this.opts={container:"body",ready:function(t){},error:function(t){}},this.outerDom=null,this.dom=null,this.domId="Tetris_"+(new Date).getTime(),this.opts=CAPR.extend(t,this.opts),this.outerDom=CAPR.q(this.opts.container),this.init()}return t.prototype.createGameDom=function(t){this.dom=document.createElement("div"),this.dom.className="capricorncd-tetris-container",this.dom.id=this.domId,this.dom.innerHTML='\n      <div class="tetris-stage"></div>\n      <div class="tetris-sider-wrapper">\n        <div class="next-square"></div>\n        <div class="tetris-statistics">\n          <div class="game-times">\n            <span class="times">00:00</span>\n          </div>\n          <div class="game-scores">\n            <span class="score">0</span>\n          </div>\n        </div>\n        <div class="control-wrapper">\n          <button class="tetris-setup">Setup</button>\n          <button class="tetris-restart">Restart</button>\n          <button class="tetris-pause">Pause</button>\n        </div>\n      </div>\n    \n      <div class="tetris-control-wrapper">\n        <div class="grid-wrapper">\n          <div class="grid"></div>\n          <div class="grid">\n            <button class="btn-rotate">Rotate</button>\n          </div>\n          <div class="grid"></div>\n        </div>\n        <div class="grid-wrapper">\n          <div class="grid">\n            <button class="btn-left">Left</button>\n          </div>\n          <div class="grid">\n            <button class="btn-fall">OK</button>\n          </div>\n          <div class="grid">\n            <button class="btn-right">Right</button>\n          </div>\n        </div>\n        <div class="grid-wrapper">\n          <div class="grid"></div>\n          <div class="grid">\n            <button class="btn-down">Down</button>\n          </div>\n          <div class="grid"></div>\n        </div>\n      </div>\n    ',this.outerDom?(this.outerDom.innerHTML="",this.outerDom.appendChild(this.dom),this.opts.ready({code:0,msg:CODES[0]+" in '"+this.opts.container+"'"}),t()):this.opts.error({code:2,msg:CODES[2]})},t.prototype.gameController=function(){var t=this;CAPR.eventListener(document,"keydown",function(e){var i=(e=e||event).keyCode;if(13===i){if(t.isGameOver)return;t.pause()}16===i&&t.restart(),t.isPause||(38===i?t.rotate():39===i?t.right():40===i?t.down():37===i?t.left():32===i&&t.fall())}),CAPR.eventListener(CAPR.q("#"+this.domId+" .btn-left"),"click",function(){t.isPause||t.left()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .btn-right"),"click",function(){t.isPause||t.right()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .btn-down"),"click",function(){t.isPause||t.down()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .btn-rotate"),"click",function(){t.isPause||t.rotate()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .btn-fall"),"click",function(){t.isPause||t.fall()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .tetris-pause"),"click",function(){t.isGameOver||t.pause()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .tetris-restart"),"click",function(){t.restart()}),CAPR.eventListener(CAPR.q("#"+this.domId+" .tetris-setup"),"click",function(){alert("开发中...")})},t.prototype.initDiv=function(t,e,i){for(var r=CAPR.ieBrowerVersion(),s=0;s<e.length;s++){for(var n=[],a=0;a<e[0].length;a++){var o=document.createElement("div");o.className="none",CAPR.isIEBrower&&r<=9?(o.style.top=20*s+"px",o.style.left=20*a+"px"):o.style.transform="translate("+20*a+"px, "+20*s+"px)",t.appendChild(o),n.push(o)}i.push(n)}},t.prototype.refreshDiv=function(t,e){void 0===t&&(t=this.stageArray),void 0===e&&(e=this.stageDivs);for(var i=0;i<t.length;i++)for(var r=0;r<t[0].length;r++)0===t[i][r]?e[i][r].className="none":1===t[i][r]?e[i][r].className="done":2===t[i][r]&&(e[i][r].className="current")},t.prototype.resetPos=function(t){void 0===t&&(t="set");var e,i,r,s;for(r=this.currSquare.origin.x,s=this.currSquare.origin.y,e=0;e<this.currSquare.data.length;e++)for(i=0;i<this.currSquare.data[0].length;i++)CAPR.checkPoint(this.currSquare.origin,e,i,this.stageArray)&&("clear"===t?this.stageArray[r+e][s+i]=0:"set"===t&&(this.stageArray[r+e][s+i]=this.currSquare.data[e][i]))},t.prototype.rotate=function(){this.currSquare.canRotate(this.stageArray)&&(this.resetPos("clear"),this.currSquare.rotate(),this.resetPos("set"),this.refreshDiv())},t.prototype.left=function(){this.currSquare.canLeft(this.stageArray)&&(this.resetPos("clear"),this.currSquare.left(),this.resetPos("set"),this.refreshDiv())},t.prototype.right=function(){this.currSquare.canRight(this.stageArray)&&(this.resetPos("clear"),this.currSquare.right(),this.resetPos("set"),this.refreshDiv())},t.prototype.down=function(){return!!this.currSquare.canDown(this.stageArray)&&(this.resetPos("clear"),this.currSquare.down(),this.resetPos("set"),this.refreshDiv(),!0)},t.prototype.fall=function(){for(;this.down(););},t.prototype.fixed=function(){var t,e,i=this.currSquare.data;for(t=0;t<i.length;t++)for(e=0;e<i[0].length;e++)CAPR.checkPoint(this.currSquare.origin,t,e,this.stageArray)&&2==this.stageArray[this.currSquare.origin.x+t][this.currSquare.origin.y+e]&&(this.stageArray[this.currSquare.origin.x+t][this.currSquare.origin.y+e]=1);this.refreshDiv()},t.prototype.checkGameOver=function(){for(var t=!1,e=0;e<this.stageArray[0].length;e++)if(1==this.stageArray[0][e]){t=!0;break}return t},t.prototype.performNext=function(t,e){this.currSquare=this.nextSquare,this.resetPos("set"),this.nextSquare=this.make(t,e),this.refreshDiv(),this.refreshDiv(this.nextSquare.data,this.nextDivs)},t.prototype.checkClear=function(){var t,e,i,r,s=0;for(t=this.stageArray.length-1;t>=0;t--){var n=!0;for(e=0;e<this.stageArray[0].length;e++)if(1!=this.stageArray[t][e]){n=!1;break}if(n){for(s+=1,i=t;i>0;i--)for(r=0;r<this.stageArray[0].length;r++)this.stageArray[i][r]=this.stageArray[i-1][r];for(r=0;r<this.stageArray[0].length;r++)this.stageArray[0][r]=0;t++}}return s},t.prototype.addTailLines=function(t){var e,i,r=this.stageArray.length,s=t.length;for(e=0;e<r-s;e++)this.stageArray[e]=this.stageArray[e+s];for(i=0;i<s;i++)this.stageArray[r-s+i]=t[i];this.currSquare.origin.x-=s,this.currSquare.origin.x<0&&(this.currSquare.origin.x=0),this.refreshDiv()},t.prototype.make=function(t,e){void 0===t&&(t=1);var i=new Square(t);return i.origin.x=0,i.origin.y=3,i.rotate(e),i},t.prototype.move=function(){if(!this.down()){this.fixed();var t=this.checkClear();this.addScore(t),this.checkGameOver()?this.stop():this.performNext(CAPR.rand(7),CAPR.rand(4))}},t.prototype.pause=function(){var t=this;this.isGameOver||(this.isPause?(this.isPause=!1,this.moveTimer=setInterval(function(){t.move()},this.INTERVAL),this.gameTimeMeter(this.gameTimes),CAPR.q("#"+this.domId+" .tetris-pause").innerText="Pause"):(this.isPause=!0,this.moveTimer&&(clearInterval(this.moveTimer),this.moveTimer=null),this.gameTimer&&(clearInterval(this.gameTimer),this.gameTimer=null),CAPR.q("#"+this.domId+" .tetris-pause").innerText="Start"))},t.prototype.restart=function(){var t=this;this.moveTimer&&(clearInterval(this.moveTimer),this.moveTimer=null),this.gameTimer&&(clearInterval(this.gameTimer),this.gameTimer=null);for(var e=0;e<this.stageArray.length;e++)for(var i=0;i<this.stageArray[0].length;i++)this.stageArray[e][i]=0;this.nextSquare=this.make(CAPR.rand(7),CAPR.rand(4)),this.refreshDiv(),this.refreshDiv(this.nextSquare.data,this.nextDivs),this.isGameOver=!1,this.isPause=!1,this.gameTimeMeter(0),this.INTERVAL=500,this.gameTimes=0,this.gameScores=0,this.performNext(CAPR.rand(7),CAPR.rand(4)),this.moveTimer=setInterval(function(){t.move()},this.INTERVAL),CAPR.q("#"+this.domId+" .tetris-pause").innerText="Pause",CAPR.q("#"+this.domId).className="capricorncd-tetris-container"},t.prototype.stop=function(){this.isGameOver=!0,this.moveTimer&&(clearInterval(this.moveTimer),this.moveTimer=null),CAPR.q("#"+this.domId).className="capricorncd-tetris-container game-over"},t.prototype.gameTimeMeter=function(t){var e=this;void 0===t&&(t=0),this.gameTimer=setInterval(function(){e.gameTimes++,CAPR.q("#"+e.domId+" .times").innerText=CAPR.ft(e.gameTimes),e.isGameOver&&clearInterval(e.gameTimer)},1e3)},t.prototype.addScore=function(t){var e=0;switch(t){case 1:e=10;break;case 2:e=30;break;case 3:e=60;break;case 4:e=100}this.gameScores+=e,CAPR.q("#"+this.domId+" .score").innerText=this.gameScores,this.setDownInterval(this.gameScores)},t.prototype.setDownInterval=function(t){t>4e3?this.INTERVAL=100:t>3500?this.INTERVAL=150:t>3e3?this.INTERVAL=200:t>2500?this.INTERVAL=250:t>2e3?this.INTERVAL=300:t>1500?this.INTERVAL=350:t>1e3?this.INTERVAL=400:t>500&&(this.INTERVAL=450)},t.prototype.init=function(){var t=this;this.createGameDom(function(){if(t.nextSquare=t.make(CAPR.rand(7),CAPR.rand(4)),t.initDiv(CAPR.q("#"+t.domId+" .tetris-stage"),t.stageArray,t.stageDivs),t.initDiv(CAPR.q("#"+t.domId+" .next-square"),t.nextSquare.data,t.nextDivs),t.refreshDiv(t.nextSquare.data,t.nextDivs),t.gameController(),t.performNext(CAPR.rand(7),CAPR.rand(4)),t.moveTimer=setInterval(function(){t.move()},t.INTERVAL),t.gameTimeMeter(),CAPR.isIEBrower&&CAPR.ieBrowerVersion()<10){var e=CAPR.q("body"),i=e.className||"";-1===i.indexOf("ie-brower")&&(e.className="ie-brower "+i)}})},t}();